name: "Update Types"

on:
  schedule:
    - cron: "0 6 * * *" # once per day at 06:00 UTC
  workflow_dispatch: # Allow manual runs

permissions:
  contents: write

jobs:
  update-types:
    runs-on: "ubuntu-latest"

    strategy:
      fail-fast: false
      matrix:
        include:
          # Add or remove SDKs here
          - branch: "sdk-v48"
            sdk: "48"
          - branch: "sdk-v49"
            sdk: "49"
          - branch: "main"
            sdk: "master"

    steps:
      - name: "Chckout branch"
        uses: "actions/checkout@v4"
        with:
          persist-credentials: true
          ref: ${{ matrix.branch }}

      - name: "Initialization steps"
        run: |
          sudo apt update -y
          sudo apt install flatpak -y
          flatpak remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo --user
          flatpak remote-add --if-not-exists gnome-nightly https://nightly.gnome.org/gnome-nightly.flatpakrepo --user

      - name: "Install nightly GNOME SDK"
        run: |
          flatpak install --user -y org.gnome.Sdk//${{ matrix.sdk }}

      - name: "Generate the types"
        run: |
          mkdir -p ~/types
          cd ~/types
          flatpak run \
          --command=bash \
          --share=network \
          --filesystem=~/types:create \
          org.gnome.Sdk//${{ matrix.sdk }} -c "
            mkdir -p "${HOME}/.nvm"

            vv #### Install latest Node LTS ### vv

            curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash
            \. "$HOME/.nvm/nvm.sh"
            nvm install 22

            ^^ ################################ ^^

            npm install @ts-for-gir/cli
            npx @ts-for-gir/cli generate '*' --ignoreVersionConflicts
          "
          ls @types

      - name: "Sync generated types to repo root"
        run: |
          SRC=~/types/@types
          DEST=$GITHUB_WORKSPACE

          # Make sure source exists
          if [ ! -d "$SRC" ]; then
            echo "Source folder $SRC does not exist"
            exit 1
          fi

          # 1. Delete .ts files in root that are not in generated output
          find "$DEST" -maxdepth 1 -type f -name "*.ts" | while read FILE; do
            BASENAME=$(basename "$FILE")
            if [ ! -f "$SRC/$BASENAME" ]; then
              echo "Deleting obsolete $BASENAME"
              rm "${FILE}"
            fi
          done

          # 2. Copy generated files into root, but only if content differs
          for FILE in "$SRC"/*.ts; do
            BASENAME=$(basename "$FILE")
            DEST_FILE="$DEST/$BASENAME"

            # Only overwrite if content differs (or file doesn't exist)
            if [ ! -f "$DEST_FILE" ] || ! cmp -s "$FILE" "$DEST_FILE"; then
              echo "Updating $BASENAME"
              cp "${FILE}" "${DEST_FILE}"
            fi
          done

          # 3. Show resulting .ts files
          ls -al "$DEST"/*.ts || true

      - name: "Commit changes"
        run: |
          cd $GITHUB_WORKSPACE
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add -A

          if ! git diff --cached --quiet; then
            git commit -m "Update GIR TypeScript declarations for SDK ${{ matrix.sdk }}"
            git push origin ${{ matrix.branch }}
          else
            echo "No changes in ${{ matrix.branch }} - nothing to commit."
          fi
