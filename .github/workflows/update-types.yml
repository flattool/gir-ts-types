name: "Update Types"

on:
  schedule:
    - cron: "0 6 * * *" # once per day at 06:00 UTC
  workflow_dispatch: # Allow manual runs

permissions:
  contents: write

jobs:
  update-types:
    runs-on: "ubuntu-latest"
    steps:
      - uses: "actions/checkout@v4"
        with:
          persist-credentials: true

      - name: "Install Flatpak"
        run: |
          sudo apt update -y
          sudo apt install flatpak -y

      - name: "Install latest GNOME SDK"
        run: |
          # Add Flathub remote
          flatpak remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo --user

          # Find latest SDK
          LATEST_SDK=$(flatpak search org.gnome.Sdk --columns=branch | sort -V | tail -n1)
          echo "Latest GNOME SDK branch: $LATEST_SDK"

          # Install it
          flatpak install --user -y org.gnome.Sdk//${LATEST_SDK}

      - name: "Generate the types"
        run: |
          mkdir -p ~/types
          cd ~/types
          flatpak run \
          --command=bash \
          --share=network \
          --filesystem=~/types:create \
          org.gnome.Sdk//${LATEST_SDK} -c "
            mkdir -p "${HOME}/.nvm"

            vv #### Install latest Node LTS ### vv

            curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash
            \. "$HOME/.nvm/nvm.sh"
            nvm install 22

            ^^ ################################ ^^

            npm install @ts-for-gir/cli
            npx @ts-for-gir/cli generate '*' --ignoreVersionConflicts
          "
          ls @types

      - name: "Sync generated types to repo root"
        run: |
          # Remove ALL existing .ts files anywhere in the repo
          #   except node_modules or hidden directories
          cd $GITHUB_WORKSPACE
          find . -maxdepth 1 -type f -name "*.ts" -delete

          # Copy new types from ~/types/@types into the repo root
          cp -r ~/types/@types/* .

          ls -al

      - name: "Commit changes"
        run: |
          cd $GITHUB_WORKSPACE
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add -A

          if ! git diff --cached --quiet; then
            git commit -m "Update generated GIR TypeScript definitions"
            git push
          else
            echo "No changes â€” nothing to commit."
          fi
